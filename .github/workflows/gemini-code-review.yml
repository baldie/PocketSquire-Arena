name: Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      - name: Google Gemini Code Review
        if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'
        id: gemini-review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DIFF=$(gh pr diff ${{ github.event.pull_request.number }})
          INSTRUCTIONS=$(cat review_agent_instructions.md)

          PROMPT=$(cat <<EOF
          review $PR_DIFF
          
          REPO: ${{ github.repository }}
          PR NUMBER: ${{ github.event.pull_request.number }}
          
          $INSTRUCTIONS
          EOF
          )

          gemini "$PROMPT" > review_output.json

      - name: Auto-merge if approved
        if: steps.gemini-review.conclusion == 'success'
        env:
          GITHUB_TOKEN: ${{secrets.REVIEWER_TOKEN}}
          PR_NUMBER: ${{github.event.pull_request.number}}
        run: |
          gh pr review $PR_NUMBER --approve -b "LGTM"
          gh pr merge $PR_NUMBER --auto --squash --delete-branch
          
          # Find the linked issue
          ISSUE_NUMBER=$(gh pr view $PR_NUMBER --json body --jq '.body' | grep -oP '(?<=Closes #)\d+' || true)
          echo "Closing associated issue: #$ISSUE_NUMBER"
          if [ ! -z "$ISSUE_NUMBER" ]; then
            gh issue close $ISSUE_NUMBER -c "Closed via Gemini Code Review auto-merge"
          else
             echo "No linked issue found."
          fi

      - name: Create Issues from Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use jq to check if the file is valid JSON and has issues
          if jq -e '. | type == "array" and length > 0' review_output.json >/dev/null 2>&1; then
            jq -c '.[]' review_output.json | while read -r issue; do
              TITLE=$(echo "$issue" | jq -r '.title')
              BODY=$(echo "$issue" | jq -r '.body')
              
              echo "Creating issue: $TITLE"
              gh issue create --title "$TITLE" --body "$BODY" --label "gemini-review"
            done
          else
            echo "No issues found or invalid JSON format returned."
          fi
