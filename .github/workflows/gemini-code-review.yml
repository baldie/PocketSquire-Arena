name: Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      - name: Google Gemini Code Review
        if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'
        id: gemini-review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DIFF=$(gh pr diff ${{ github.event.pull_request.number }})

          PROMPT=$(cat <<EOF
          review $PR_DIFF
          You are an expert code reviewer. Please review the pull request.
          If the code is good and you have no suggestions, exit with a success code.
          Otherwise, leave comments on the pull request with your suggestions and exit with a failure code.
          
          REPO: ${{ github.repository }}
          PR NUMBER: ${{ github.event.pull_request.number }}
          
          Perform a comprehensive code review with the following focus areas:
          
          1. **Code Quality**
          - Clean code principles and best practices
          - Proper error handling and edge cases
          - Code readability and maintainability
          
          2. **Security**
          - Check for potential security vulnerabilities
          - Validate input sanitization
          - Review authentication/authorization logic
          
          3. **Performance**
          - Identify potential performance bottlenecks
          - Review database queries for efficiency
          - Check for memory leaks or resource issues
          
          4. **Testing**
          - Verify adequate test coverage
          - Review test quality and edge cases
          - Check for missing test scenarios
          EOF
          )

          gemini "$PROMPT"

      - name: Auto-merge if approved
        if: steps.gemini-review.conclusion == 'success'
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
          PR_NUMBER: ${{github.event.pull_request.number}}
        run: |
          gh pr review $PR_NUMBER --approve -b "LGTM"
          gh pr merge $PR_NUMBER --auto --squash --delete-branch
          
          # Find the linked issue
          ISSUE_NUMBER=$(gh pr view $PR_NUMBER --json body --jq '.body' | grep -oP '(?<=Closes #)\d+' || true)
          echo "Closing associated issue: #$ISSUE_NUMBER"
          if [ ! -z "$ISSUE_NUMBER" ]; then
            gh issue close $ISSUE_NUMBER -c "Closed via Gemini Code Review auto-merge"
          else
             echo "No linked issue found."
          fi

      - name: Trigger Author Agent
        if: failure()
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
          PR_NUMBER: ${{github.event.pull_request.number}}
        run: |
          # Get the PR labels
          PR_LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels | .[].name')
          echo "PR Labels: $PR_LABELS"
          
          if [ -z "$PR_LABELS" ]; then
            echo "No labels found on PR."
            exit 0
          fi
          
          # Find the domain label
          DOMAIN_LABEL=$(echo "$PR_LABELS" | grep "domain-" || true)
          
          if [ -z "$DOMAIN_LABEL" ]; then
            echo "No domain label found."
            exit 0
          fi
          
          echo "Domain Label: $DOMAIN_LABEL"
          # Extract the domain
          DOMAIN=$(echo "$DOMAIN_LABEL" | cut -d'-' -f2)
          echo "Domain: $DOMAIN"
          # Construct the author label
          AUTHOR_LABEL="author-$DOMAIN"
          echo "Author Label: $AUTHOR_LABEL"
          # Find the linked issue
          ISSUE_NUMBER=$(gh pr view $PR_NUMBER --json body --jq '.body' | grep -oP '(?<=Closes #)\d+')
          echo "Issue Number: $ISSUE_NUMBER"
          # Add the author label to the issue
          gh issue edit $ISSUE_NUMBER --add-label "$AUTHOR_LABEL"

