name: Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  gemini-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      - name: Google Gemini Code Review
        if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]'
        id: gemini-review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DIFF=$(gh pr diff ${{ github.event.pull_request.number }})
          INSTRUCTIONS=$(cat review_agent_instructions.md)

          PROMPT=$(cat <<EOF
          Review the following diff:
          $PR_DIFF
          
          Context:
          REPO: ${{ github.repository }}
          PR NUMBER: ${{ github.event.pull_request.number }}
          
          Instructions:
          $INSTRUCTIONS
          EOF
          )

          # Capture output and strip potential Markdown code blocks (```json ... ```)
          gemini "$PROMPT" | sed 's/```json//g; s/```//g' > review_output.json

      - name: Create Issues and Validate Review
        id: process-review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if review_output.json contains a non-empty array
          if jq -e '. | type == "array" and length > 0' review_output.json >/dev/null 2>&1; then
            echo "Issues found by Gemini. Creating GitHub Issues..."
            
            jq -c '.[]' review_output.json | while read -r issue; do
              TITLE=$(echo "$issue" | jq -r '.title')
              BODY=$(echo "$issue" | jq -r '.body')
              
              # Create the issue and label it with the PR number for traceability
              gh issue create \
                --title "$TITLE" \
                --body "$BODY" \
                --label "gemini-review" \
                --label "pr-${{ github.event.pull_request.number }}"
            done
            
            echo "Blocking merge due to identified issues."
            exit 1 # This stops the workflow here; 'Auto-merge' will be skipped
          else
            echo "No issues found. Review passed."
          fi

      - name: Auto-merge if approved
        # This step only runs if 'Create Issues' finished with exit code 0 (no issues found)
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.REVIEWER_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr review $PR_NUMBER --approve -b "LGTM - Gemini found no issues."
          gh pr merge $PR_NUMBER --auto --squash --delete-branch
          
          # Find and close the original linked issue (e.g., "Closes #123")
          ISSUE_NUMBER=$(gh pr view $PR_NUMBER --json body --jq '.body' | grep -oP '(?<=Closes #)\d+' || true)
          if [ ! -z "$ISSUE_NUMBER" ]; then
            echo "Closing associated issue: #$ISSUE_NUMBER"
            gh issue close $ISSUE_NUMBER -c "Closed via Gemini Code Review auto-merge"
          else
            echo "No linked issue found to close."
          fi

      - name: Trigger Author Agent
        # This runs ONLY if 'Create Issues' exited with 1 (meaning bugs were found)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          PR_LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels | .[].name')
          DOMAIN_LABEL=$(echo "$PR_LABELS" | grep "domain-" || true)
          
          if [ ! -z "$DOMAIN_LABEL" ]; then
            DOMAIN=$(echo "$DOMAIN_LABEL" | cut -d'-' -f2)
            AUTHOR_LABEL="author-$DOMAIN"
            
            # Extract original issue linked in the PR body
            ISSUE_NUMBER=$(gh pr view $PR_NUMBER --json body --jq '.body' | grep -oP '(?<=Closes #)\d+' || true)
            
            if [ ! -z "$ISSUE_NUMBER" ]; then
              echo "Assigning ps-agent-1 to issue #$ISSUE_NUMBER"
              gh issue edit $ISSUE_NUMBER --add-assignee "ps-agent-1" --add-label "$AUTHOR_LABEL"
            fi
          fi