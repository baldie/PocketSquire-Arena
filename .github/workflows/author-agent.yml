name: Author Agent

on:
  issues:
    types: [labeled]

jobs:
  author-agent:
    # Only run when one of the author labels is applied
    if: contains(fromJSON('["author-menu", "author-town", "author-arena"]'), github.event.label.name)
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Install Playwright
        run: npx playwright install --with-deps chromium
        env:
          PLAYWRIGHT_BROWSERS_PATH: "0"

      - name: Install Beads CLI
        run: |
          # Install beads CLI for issue tracking (steveyegge/beads)
          curl -fsSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash
          bd --version
          # Initialize beads if not already initialized
          bd init || true

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine Agent Scope
        id: scope
        run: |
          LABEL="${{ github.event.label.name }}"
          case "$LABEL" in
            author-menu)
              echo "domain=menu" >> $GITHUB_OUTPUT
              echo "write_paths=Assets/Scripts/Menu/**,Assets/Scenes/Menu/**" >> $GITHUB_OUTPUT
              echo "description=Menu and UI systems" >> $GITHUB_OUTPUT
              ;;
            author-town)
              echo "domain=town" >> $GITHUB_OUTPUT
              echo "write_paths=Assets/Scripts/Town/**,Assets/Scenes/Town/**" >> $GITHUB_OUTPUT
              echo "description=Town gameplay and systems" >> $GITHUB_OUTPUT
              ;;
            author-arena)
              echo "domain=arena" >> $GITHUB_OUTPUT
              echo "write_paths=Assets/Scripts/Arena/**,Assets/Scripts/Core/**,Assets/Scenes/Arena/**" >> $GITHUB_OUTPUT
              echo "description=Arena combat and core gameplay" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Load Agent Instructions
        id: instructions
        run: |
          # Load base instructions
          BASE=$(cat author_agent_instructions.md)
          echo "base<<EOF" >> $GITHUB_OUTPUT
          echo "$BASE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Load domain-specific instructions
          DOMAIN="${{ steps.scope.outputs.domain }}"
          DOMAIN_FILE="author_agent_instructions_${DOMAIN}.md"

          if [ -f "$DOMAIN_FILE" ]; then
            DOMAIN_INSTRUCTIONS=$(cat "$DOMAIN_FILE")
          else
            DOMAIN_INSTRUCTIONS="No domain-specific instructions found."
          fi

          echo "domain<<EOF" >> $GITHUB_OUTPUT
          echo "$DOMAIN_INSTRUCTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Author Agent
        uses: anthropics/claude-code-action@v1
        env:
          # Tools running inside the agent (gh, playwright) need these in the environment
          GITHUB_TOKEN: ${{ secrets.REVIEWER_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PLAYWRIGHT_BROWSERS_PATH: "0"
          CI: "true"
        with:
          # The action wrapper specifically requests these as inputs
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.REVIEWER_TOKEN }}
          
          prompt: |
            You are the Author Agent for the **${{ steps.scope.outputs.domain }}** domain (${{ steps.scope.outputs.description }}).

            ---
            ## AUTHOR AGENT CONSTITUTION
            The following instructions are MANDATORY. Follow them exactly.

            ${{ steps.instructions.outputs.base }}

            ---
            ## DOMAIN-SPECIFIC INSTRUCTIONS (${{ steps.scope.outputs.domain }})

            ${{ steps.instructions.outputs.domain }}

            ---
            ## YOUR ASSIGNED TASK

            **GitHub Issue #${{ github.event.issue.number }}**
            **Title:** ${{ github.event.issue.title }}

            **Description:**
            ${{ github.event.issue.body }}

            ---
            ## EXECUTION CHECKLIST

            1. **Start**: Run `npm run task:start -- --title "${{ github.event.issue.title }}" --description "${{ github.event.issue.body }}"`
            2. **Develop**: Write code to address the issue.
            3. **Verify**:
               - Run `npm run test:unit`
            4. **Commit**: `git add .` and `git commit -m "..."`
            5. **Create PR**: `gh pr create --fill`
            6. **Push**: `git push`
            7. **Label PR**: `gh pr edit --add-label "domain-${{ steps.scope.outputs.domain }}"`
            8. **Finish**: Run `npm run task:submit`

            Begin implementation now.

          claude_args: |
            --allowedTools "npm,git,gh,Edit,Write,Read,Glob,Grep"
            --max-turns 50
            --dangerously-skip-permissions

      - name: Comment on Issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const domain = '${{ steps.scope.outputs.domain }}';
            const body = status === 'success'
              ? `ü§ñ **Author Agent (${domain})** has completed work on this issue. Check the linked PR for changes.`
              : `‚ö†Ô∏è **Author Agent (${domain})** encountered an issue while working on this task. Please review the workflow logs.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });