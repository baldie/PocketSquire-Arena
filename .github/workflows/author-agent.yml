name: Author Agent

on:
  issues:
    types: [labeled]

jobs:
  author-agent:
    # Only run when one of the author labels is applied
    if: contains(fromJSON('["author-menu", "author-town", "author-arena"]'), github.event.label.name)
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations
          lfs: true       # Important for Unity projects

      # [Fix 2] Git config must be set for the agent to commit changes
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      # [Fix 4] Install http-server so Playwright can serve the WebGL build
      - name: Install http-server
        run: npm install -g http-server

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Install Beads CLI
        run: |
          # Install beads CLI for issue tracking (steveyegge/beads)
          curl -fsSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash
          bd --version
          # [Fix 1] Initialize beads database
          bd init

      # [Fix 5] Build WebGL artifact so tests have something to run against
      # Note: Requires UNITY_LICENSE and UNITY_EMAIL secrets in the repo
      - name: Build WebGL
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        with:
          targetPlatform: WebGL
          buildName: PocketSquire
          allowDirtyBuild: true

      - name: Determine Agent Scope
        id: scope
        run: |
          LABEL="${{ github.event.label.name }}"
          case "$LABEL" in
            author-menu)
              echo "domain=menu" >> $GITHUB_OUTPUT
              echo "write_paths=Assets/Scripts/Menu/**,Assets/Scenes/Menu/**" >> $GITHUB_OUTPUT
              echo "description=Menu and UI systems" >> $GITHUB_OUTPUT
              ;;
            author-town)
              echo "domain=town" >> $GITHUB_OUTPUT
              echo "write_paths=Assets/Scripts/Town/**,Assets/Scenes/Town/**" >> $GITHUB_OUTPUT
              echo "description=Town gameplay and systems" >> $GITHUB_OUTPUT
              ;;
            author-arena)
              echo "domain=arena" >> $GITHUB_OUTPUT
              echo "write_paths=Assets/Scripts/Arena/**,Assets/Scripts/Core/**,Assets/Scenes/Arena/**" >> $GITHUB_OUTPUT
              echo "description=Arena combat and core gameplay" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Load Agent Instructions
        id: instructions
        run: |
          # Load base instructions
          BASE=$(cat author_agent_instructions.md)
          echo "base<<EOF" >> $GITHUB_OUTPUT
          echo "$BASE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Load domain-specific instructions
          DOMAIN="${{ steps.scope.outputs.domain }}"
          DOMAIN_FILE="author_agent_instructions_${DOMAIN}.md"

          if [ -f "$DOMAIN_FILE" ]; then
            DOMAIN_INSTRUCTIONS=$(cat "$DOMAIN_FILE")
          else
            DOMAIN_INSTRUCTIONS="No domain-specific instructions found."
          fi

          echo "domain<<EOF" >> $GITHUB_OUTPUT
          echo "$DOMAIN_INSTRUCTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Author Agent
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            You are the Author Agent for the **${{ steps.scope.outputs.domain }}** domain (${{ steps.scope.outputs.description }}).

            ---
            ## AUTHOR AGENT CONSTITUTION
            The following instructions are MANDATORY. Follow them exactly.

            ${{ steps.instructions.outputs.base }}

            ---
            ## DOMAIN-SPECIFIC INSTRUCTIONS (${{ steps.scope.outputs.domain }})

            ${{ steps.instructions.outputs.domain }}

            ---
            ## YOUR ASSIGNED TASK

            **GitHub Issue #${{ github.event.issue.number }}**
            **Title:** ${{ github.event.issue.title }}

            **Description:**
            ${{ github.event.issue.body }}

            ---
            ## EXECUTION CHECKLIST

            1. Create bead: `bd create "${{ github.event.issue.title }}" --type task --priority 2 --description="GitHub Issue #${{ github.event.issue.number }}"`
            2. Implement the requested changes
            3. Start server: `npx http-server build/WebGL -p 8080 &`
            4. Run verification: `npx playwright test` (MUST PASS)
            5. Commit with bead ID in message
            6. Create PR referencing: `Closes #${{ github.event.issue.number }}`
            7. Close bead: `bd close <bead-id>`
            8. Sync: `bd sync`

            Begin implementation now.

          # [Fix 3] allowed_tools format checked
          # Ensure http-server is allowed if it's not covered by Bash(*)
          claude_args: |
            --allowedTools "Bash(npm test),Bash(npm install),Bash(npx playwright test),Bash(npx playwright install),Bash(npx http-server *),Bash(bd *),Bash(git *),Bash(gh *),Edit,Write,Read,Glob,Grep"
            --max-turns 50

          settings: |
            {
              "env": {
                "CI": "true",
                "PLAYWRIGHT_BROWSERS_PATH": "0"
              }
            }

          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on Issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const domain = '${{ steps.scope.outputs.domain }}';
            const body = status === 'success' 
              ? `ü§ñ **Author Agent (${domain})** has completed work on this issue. Check the linked PR for changes.`
              : `‚ö†Ô∏è **Author Agent (${domain})** encountered an issue while working on this task. Please review the workflow logs.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
