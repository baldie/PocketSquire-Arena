name: Author Agent

on:
  issues:
    types: [labeled]

jobs:
  author-agent:
    # Only run when one of the author labels is applied
    if: contains(fromJSON('["author-menu", "author-town", "author-arena"]'), github.event.label.name)
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Configure git for author bot
        run: |
          git config --global user.name "PocketSquire Author Bot"
          git config --global user.email "author-agent@pocketsquirearena.com"
          git config --local --unset-all http.https://github.com/.extraheader || true
          git remote set-url origin \
            https://x-access-token:${{ secrets.AUTHOR_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Determine Agent Scope & Branch
        id: scope
        env:
          GITHUB_TOKEN: ${{ secrets.AUTHOR_TOKEN }}
        run: |
          # 1. Determine Domain
          LABEL="${{ github.event.label.name }}"
          case "$LABEL" in
            author-menu)
              echo "domain=menu" >> $GITHUB_OUTPUT
              echo "description=Menu and UI systems" >> $GITHUB_OUTPUT
              ;;
            author-town)
              echo "domain=town" >> $GITHUB_OUTPUT
              echo "description=Town gameplay and systems" >> $GITHUB_OUTPUT
              ;;
            author-arena)
              echo "domain=arena" >> $GITHUB_OUTPUT
              echo "description=Arena combat and core gameplay" >> $GITHUB_OUTPUT
              ;;
          esac

          # 2. Identify the PR branch from labels (e.g., pr-123)
          ISSUE_LABELS=$(gh issue view ${{ github.event.issue.number }} --json labels --jq '.labels.[].name')
          PR_NUMBER=$(echo "$ISSUE_LABELS" | grep -oP '(?<=pr-)\d+' || true)
          
          if [ ! -z "$PR_NUMBER" ]; then
            echo "Found linked PR #$PR_NUMBER. Fetching branch..."
            BRANCH_NAME=$(gh pr view $PR_NUMBER --json headRefName --jq '.headRefName')
            echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
            git checkout $BRANCH_NAME
          else
            echo "No linked PR found. Working on a new branch from main."
            NEW_BRANCH="fix/issue-${{ github.event.issue.number }}"
            git checkout -b $NEW_BRANCH
            echo "branch=$NEW_BRANCH" >> $GITHUB_OUTPUT
          fi

      - name: Load Agent Instructions
        id: instructions
        run: |
          BASE=$(cat author_agent_instructions.md)
          echo "base<<EOF" >> $GITHUB_OUTPUT
          echo "$BASE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          DOMAIN="${{ steps.scope.outputs.domain }}"
          DOMAIN_FILE="author_agent_instructions_${DOMAIN}.md"
          if [ -f "$DOMAIN_FILE" ]; then
            DOMAIN_INSTRUCTIONS=$(cat "$DOMAIN_FILE")
          else
            DOMAIN_INSTRUCTIONS="No domain-specific instructions found."
          fi
          echo "domain<<EOF" >> $GITHUB_OUTPUT
          echo "$DOMAIN_INSTRUCTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Author Agent (Claude Code)
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.AUTHOR_TOKEN }}
          prompt: |
            You are the Author Agent for the **${{ steps.scope.outputs.domain }}** domain.
            
            WORK CONTEXT:
            You are currently working on branch: `${{ steps.scope.outputs.branch }}`.
            Any code changes you make MUST be committed and pushed to this branch.

            ## AUTHOR AGENT CONSTITUTION
            ${{ steps.instructions.outputs.base }}

            ## DOMAIN-SPECIFIC INSTRUCTIONS
            ${{ steps.instructions.outputs.domain }}

            ## YOUR ASSIGNED TASK
            **GitHub Issue #${{ github.event.issue.number }}**
            **Title:** ${{ github.event.issue.title }}
            **Description:**
            ${{ github.event.issue.body }}
          claude_args: |
            --allowedTools "npm,git,gh,Edit,Write,Read,Glob,Grep"
            --max-turns 50
            --dangerously-skip-permissions

      - name: Comment on Issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const domain = '${{ steps.scope.outputs.domain }}';
            const branch = '${{ steps.scope.outputs.branch }}';
            const body = status === 'success'
              ? `ü§ñ **Author Agent (${domain})** has applied fixes to branch \`${branch}\`. This should trigger a re-review.`
              : `‚ö†Ô∏è **Author Agent (${domain})** failed to apply fixes. Check logs for details.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });